# Grafana Datasources for ACM Observability Stack
# Place this file in Grafana's provisioning/datasources/ folder
# or use the Grafana API to create these datasources

apiVersion: 1

datasources:
  # Tempo - Distributed Tracing
  - name: Tempo
    type: tempo
    access: proxy
    url: http://localhost:3200
    uid: tempo-ds
    isDefault: false
    jsonData:
      httpMethod: GET
      serviceMap:
        datasourceUid: prometheus  # Optional: for service graph
      search:
        hide: false
      nodeGraph:
        enabled: true
      tracesToLogsV2:
        datasourceUid: loki-ds
        spanStartTimeShift: '-1h'
        spanEndTimeShift: '1h'
        filterByTraceID: true
        filterBySpanID: false
        customQuery: false
      tracesToProfiles:
        datasourceUid: pyroscope-ds
        profileTypeId: process_cpu:cpu:nanoseconds:cpu:nanoseconds
        customQuery: true
        query: 'service_name="${__span.serviceName}"'

  # Pyroscope - Continuous Profiling
  - name: Pyroscope
    type: grafana-pyroscope-datasource
    access: proxy
    url: http://localhost:4040
    uid: pyroscope-ds
    isDefault: false
    jsonData: {}

  # Loki - Log Aggregation
  - name: Loki
    type: loki
    access: proxy
    url: http://localhost:3100
    uid: loki-ds
    isDefault: false
    jsonData:
      maxLines: 1000
      derivedFields:
        - datasourceUid: tempo-ds
          matcherRegex: '"trace_id":"([a-f0-9]+)"'
          name: TraceID
          url: '$${__value.raw}'

  # Microsoft SQL Server - ACM Business Data
  # For standalone (non-Docker) Grafana installations
  - name: MSSQL
    type: mssql
    access: proxy
    uid: mssql-ds
    isDefault: false
    jsonData:
      server: localhost\B19CL3PCQLSERVER
      database: ACM
      encrypt: "disable"
      authenticationType: windows
      connectionTimeout: 30
    secureJsonData: {}
    editable: true
