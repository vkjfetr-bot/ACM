# ACM SQL Metrics for Grafana Alloy MSSQL Exporter
# =================================================
# 
# This file defines custom Prometheus metrics scraped from ACM SQL tables.
# Copy to: C:\Program Files\GrafanaLabs\Alloy\acm_sql_metrics.yaml
#
# All metrics are prefixed with "acm_sql_" and properly labeled.

collector_name: acm_operational_metrics

metrics:
  # ===========================================================================
  # RUN METRICS - Track pipeline execution
  # ===========================================================================
  
  - metric_name: acm_sql_runs_total
    type: counter
    help: "Total ACM runs by equipment and outcome from ACM_Runs table"
    key_labels:
      - equipment
      - outcome
    values: [run_count]
    query: |
      SELECT 
        e.EquipCode AS equipment,
        CASE 
          WHEN r.Outcome IS NULL THEN 'UNKNOWN'
          ELSE r.Outcome 
        END AS outcome,
        COUNT(*) AS run_count
      FROM ACM_Runs r
      INNER JOIN Equipment e ON r.EquipID = e.EquipID
      GROUP BY e.EquipCode, r.Outcome

  - metric_name: acm_sql_runs_last_24h
    type: gauge
    help: "ACM runs in the last 24 hours by equipment"
    key_labels:
      - equipment
    values: [run_count]
    query: |
      SELECT 
        e.EquipCode AS equipment,
        COUNT(*) AS run_count
      FROM ACM_Runs r
      INNER JOIN Equipment e ON r.EquipID = e.EquipID
      WHERE r.StartedAt >= DATEADD(HOUR, -24, GETDATE())
      GROUP BY e.EquipCode

  - metric_name: acm_sql_run_duration_seconds
    type: gauge
    help: "Average run duration in seconds by equipment (last 24h)"
    key_labels:
      - equipment
    values: [avg_duration_seconds]
    query: |
      SELECT 
        e.EquipCode AS equipment,
        AVG(DATEDIFF(SECOND, r.StartedAt, r.FinishedAt)) AS avg_duration_seconds
      FROM ACM_Runs r
      INNER JOIN Equipment e ON r.EquipID = e.EquipID
      WHERE r.StartedAt >= DATEADD(HOUR, -24, GETDATE())
        AND r.FinishedAt IS NOT NULL
      GROUP BY e.EquipCode

  - metric_name: acm_sql_last_run_timestamp
    type: gauge
    help: "Unix timestamp of last successful run by equipment"
    key_labels:
      - equipment
    values: [last_run_unix]
    query: |
      SELECT 
        e.EquipCode AS equipment,
        DATEDIFF(SECOND, '1970-01-01', MAX(r.StartedAt)) AS last_run_unix
      FROM ACM_Runs r
      INNER JOIN Equipment e ON r.EquipID = e.EquipID
      WHERE r.Outcome = 'SUCCESS'
      GROUP BY e.EquipCode

  # ===========================================================================
  # DATA VOLUME METRICS - Track data processing
  # ===========================================================================
  
  - metric_name: acm_sql_scores_rows_total
    type: gauge
    help: "Total rows in ACM_Scores_Wide by equipment"
    key_labels:
      - equipment
    values: [row_count]
    query: |
      SELECT 
        e.EquipCode AS equipment,
        COUNT(*) AS row_count
      FROM ACM_Scores_Wide s
      INNER JOIN Equipment e ON s.EquipID = e.EquipID
      GROUP BY e.EquipCode

  - metric_name: acm_sql_scores_latest_timestamp
    type: gauge
    help: "Unix timestamp of most recent score by equipment"
    key_labels:
      - equipment
    values: [latest_unix]
    query: |
      SELECT 
        e.EquipCode AS equipment,
        DATEDIFF(SECOND, '1970-01-01', MAX(s.Timestamp)) AS latest_unix
      FROM ACM_Scores_Wide s
      INNER JOIN Equipment e ON s.EquipID = e.EquipID
      GROUP BY e.EquipCode

  - metric_name: acm_sql_health_timeline_rows
    type: gauge
    help: "Rows in ACM_HealthTimeline by equipment"
    key_labels:
      - equipment
    values: [row_count]
    query: |
      SELECT 
        e.EquipCode AS equipment,
        COUNT(*) AS row_count
      FROM ACM_HealthTimeline h
      INNER JOIN Equipment e ON h.EquipID = e.EquipID
      GROUP BY e.EquipCode

  # ===========================================================================
  # ANOMALY METRICS - Track anomaly detection
  # ===========================================================================
  
  - metric_name: acm_sql_anomaly_events_total
    type: gauge
    help: "Total anomaly events by equipment and severity"
    key_labels:
      - equipment
      - severity
    values: [event_count]
    query: |
      SELECT 
        e.EquipCode AS equipment,
        COALESCE(ae.Severity, 'UNKNOWN') AS severity,
        COUNT(*) AS event_count
      FROM ACM_Anomaly_Events ae
      INNER JOIN Equipment e ON ae.EquipID = e.EquipID
      GROUP BY e.EquipCode, ae.Severity

  - metric_name: acm_sql_active_defects
    type: gauge
    help: "Current active defects by equipment"
    key_labels:
      - equipment
    values: [defect_count]
    query: |
      SELECT 
        e.EquipCode AS equipment,
        COUNT(*) AS defect_count
      FROM ACM_DefectStatus ds
      INNER JOIN Equipment e ON ds.EquipID = e.EquipID
      WHERE ds.ActiveDefect = 1
      GROUP BY e.EquipCode

  # ===========================================================================
  # EPISODE METRICS - Track diagnostic episodes
  # ===========================================================================
  
  - metric_name: acm_sql_episodes_total
    type: gauge
    help: "Total episodes by equipment"
    key_labels:
      - equipment
    values: [episode_count]
    query: |
      SELECT 
        e.EquipCode AS equipment,
        COALESCE(SUM(em.TotalEpisodes), 0) AS episode_count
      FROM ACM_EpisodeMetrics em
      INNER JOIN ACM_Runs r ON em.RunID = r.RunID
      INNER JOIN Equipment e ON r.EquipID = e.EquipID
      GROUP BY e.EquipCode

  - metric_name: acm_sql_episode_duration_hours
    type: gauge
    help: "Total episode duration in hours by equipment"
    key_labels:
      - equipment
    values: [duration_hours]
    query: |
      SELECT 
        e.EquipCode AS equipment,
        COALESCE(SUM(em.TotalDurationHours), 0) AS duration_hours
      FROM ACM_EpisodeMetrics em
      INNER JOIN ACM_Runs r ON em.RunID = r.RunID
      INNER JOIN Equipment e ON r.EquipID = e.EquipID
      GROUP BY e.EquipCode

  # ===========================================================================
  # RUL/FORECAST METRICS - Track predictions
  # ===========================================================================
  
  - metric_name: acm_sql_rul_hours
    type: gauge
    help: "Latest RUL prediction in hours by equipment"
    key_labels:
      - equipment
      - method
    values: [rul_hours]
    query: |
      WITH LatestRUL AS (
        SELECT 
          EquipID,
          Method,
          RUL_Hours,
          ROW_NUMBER() OVER (PARTITION BY EquipID ORDER BY CreatedAt DESC) AS rn
        FROM ACM_RUL
        WHERE RUL_Hours IS NOT NULL
      )
      SELECT 
        e.EquipCode AS equipment,
        lr.Method AS method,
        lr.RUL_Hours AS rul_hours
      FROM LatestRUL lr
      INNER JOIN Equipment e ON lr.EquipID = e.EquipID
      WHERE lr.rn = 1

  - metric_name: acm_sql_health_current
    type: gauge
    help: "Current health score (0-100) by equipment"
    key_labels:
      - equipment
    values: [health_score]
    query: |
      WITH LatestHealth AS (
        SELECT 
          EquipID,
          Health,
          ROW_NUMBER() OVER (PARTITION BY EquipID ORDER BY Timestamp DESC) AS rn
        FROM ACM_HealthTimeline
      )
      SELECT 
        e.EquipCode AS equipment,
        lh.Health AS health_score
      FROM LatestHealth lh
      INNER JOIN Equipment e ON lh.EquipID = e.EquipID
      WHERE lh.rn = 1

  # ===========================================================================
  # MODEL METRICS - Track model registry
  # ===========================================================================
  
  - metric_name: acm_sql_models_count
    type: gauge
    help: "Number of models in registry by equipment and type"
    key_labels:
      - equipment
      - model_type
    values: [model_count]
    query: |
      SELECT 
        e.EquipCode AS equipment,
        mr.ModelType AS model_type,
        COUNT(*) AS model_count
      FROM ModelRegistry mr
      INNER JOIN Equipment e ON mr.EquipID = e.EquipID
      GROUP BY e.EquipCode, mr.ModelType

  - metric_name: acm_sql_model_size_bytes
    type: gauge
    help: "Total model blob size in bytes by equipment"
    key_labels:
      - equipment
    values: [total_bytes]
    query: |
      SELECT 
        e.EquipCode AS equipment,
        SUM(DATALENGTH(mr.ModelBlob)) AS total_bytes
      FROM ModelRegistry mr
      INNER JOIN Equipment e ON mr.EquipID = e.EquipID
      GROUP BY e.EquipCode

  # ===========================================================================
  # LOG METRICS - Track run logs
  # ===========================================================================
  
  - metric_name: acm_sql_logs_by_level
    type: gauge
    help: "Log entries in last 24h by equipment and level"
    key_labels:
      - equipment
      - log_level
    values: [log_count]
    query: |
      SELECT 
        e.EquipCode AS equipment,
        rl.LogLevel AS log_level,
        COUNT(*) AS log_count
      FROM ACM_RunLogs rl
      INNER JOIN ACM_Runs r ON rl.RunID = r.RunID
      INNER JOIN Equipment e ON r.EquipID = e.EquipID
      WHERE rl.LoggedAt >= DATEADD(HOUR, -24, GETDATE())
      GROUP BY e.EquipCode, rl.LogLevel

  - metric_name: acm_sql_errors_last_24h
    type: gauge
    help: "Error log entries in last 24 hours by equipment"
    key_labels:
      - equipment
    values: [error_count]
    query: |
      SELECT 
        e.EquipCode AS equipment,
        COUNT(*) AS error_count
      FROM ACM_RunLogs rl
      INNER JOIN ACM_Runs r ON rl.RunID = r.RunID
      INNER JOIN Equipment e ON r.EquipID = e.EquipID
      WHERE rl.LoggedAt >= DATEADD(HOUR, -24, GETDATE())
        AND rl.LogLevel = 'ERROR'
      GROUP BY e.EquipCode

  # ===========================================================================
  # TABLE SIZE METRICS - Monitor table growth
  # ===========================================================================
  
  - metric_name: acm_sql_table_rows
    type: gauge
    help: "Row count per ACM table"
    key_labels:
      - table_name
    values: [row_count]
    query: |
      SELECT 
        t.name AS table_name,
        SUM(p.rows) AS row_count
      FROM sys.tables t
      INNER JOIN sys.partitions p ON t.object_id = p.object_id
      WHERE t.name LIKE 'ACM_%' 
        AND p.index_id IN (0, 1)
      GROUP BY t.name

  - metric_name: acm_sql_table_size_mb
    type: gauge
    help: "Table size in MB per ACM table"
    key_labels:
      - table_name
    values: [size_mb]
    query: |
      SELECT 
        t.name AS table_name,
        CAST(SUM(a.total_pages) * 8.0 / 1024 AS DECIMAL(10,2)) AS size_mb
      FROM sys.tables t
      INNER JOIN sys.indexes i ON t.object_id = i.object_id
      INNER JOIN sys.partitions p ON i.object_id = p.object_id AND i.index_id = p.index_id
      INNER JOIN sys.allocation_units a ON p.partition_id = a.container_id
      WHERE t.name LIKE 'ACM_%'
      GROUP BY t.name

  # ===========================================================================
  # DATABASE HEALTH METRICS - SQL Server internals
  # ===========================================================================
  
  - metric_name: acm_sql_database_size_mb
    type: gauge
    help: "ACM database size in MB"
    values: [size_mb]
    query: |
      SELECT 
        CAST(SUM(size) * 8.0 / 1024 AS DECIMAL(10,2)) AS size_mb
      FROM sys.database_files

  - metric_name: acm_sql_active_connections
    type: gauge
    help: "Active connections to ACM database"
    values: [connection_count]
    query: |
      SELECT COUNT(*) AS connection_count
      FROM sys.dm_exec_sessions
      WHERE database_id = DB_ID('ACM')
        AND session_id != @@SPID
