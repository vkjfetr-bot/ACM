# Grafana Datasources for ACM Observability Stack (Docker)
# ==========================================================
# Auto-provisioned when Grafana starts
# Uses Docker container names for internal networking
#
# CRITICAL: Tag Mapping Rules for tracesToMetrics/tracesToLogs/tracesToProfiles
# ==============================================================================
# ACM span attributes use "acm." prefix (e.g., acm.equipment, acm.run_id)
# Prometheus/Loki labels do NOT have prefix (e.g., equipment, run_id)
#
# The tags config maps:
#   key: <span attribute name>  ->  value: <query variable name>
#
# Example:
#   tags:
#     - key: acm.equipment      # Span attribute to extract FROM
#       value: equipment        # Query variable to use AS ${__span.tags.equipment}
#
# NEVER use ${__span.tags["acm.equipment"]} - use the 'value' name instead!
# ==============================================================================

apiVersion: 1

datasources:
  # Prometheus - Metrics (DEFAULT)
  - name: Prometheus
    type: prometheus
    access: proxy
    url: http://prometheus:9090
    uid: prometheus-ds
    isDefault: true
    jsonData:
      httpMethod: POST
      exemplarTraceIdDestinations:
        - name: trace_id
          datasourceUid: tempo-ds
          urlDisplayLabel: View Trace

  # Tempo - Distributed Tracing
  - name: Tempo
    type: tempo
    access: proxy
    url: http://tempo:3200
    uid: tempo-ds
    isDefault: false
    jsonData:
      httpMethod: GET
      serviceMap:
        datasourceUid: prometheus-ds
      search:
        hide: false
      nodeGraph:
        enabled: true
      lokiSearch:
        datasourceUid: loki-ds
      tracesToLogsV2:
        datasourceUid: loki-ds
        spanStartTimeShift: '-5m'
        spanEndTimeShift: '5m'
        filterByTraceID: true
        filterBySpanID: false
        customQuery: true
        # Use label filter {trace_id="xxx"} not line filter |trace_id=xxx
        query: '{app="acm", trace_id="${__trace.traceId}"}'
        tags:
          - key: acm.equipment
            value: equipment
          - key: acm.run_id
            value: run_id
      tracesToMetrics:
        datasourceUid: prometheus-ds
        spanStartTimeShift: '-5m'
        spanEndTimeShift: '5m'
        tags:
          - key: acm.equipment
            value: equipment
        queries:
          - name: Stage Duration
            query: 'acm_stage_duration_seconds_sum{equipment="${__span.tags.equipment}"}'
          - name: Memory Usage
            query: 'acm_memory_rss_mb{equipment="${__span.tags.equipment}"}'
      # Trace-to-Profile correlation
      # Links from Tempo traces to Pyroscope profiles using service_name label
      tracesToProfiles:
        datasourceUid: pyroscope-ds
        # CPU profile type - ACM uses HTTP ingestion API with custom app name
        # Format: app_name.profile_type:sample_type:sample_unit::
        profileTypeId: "acm.cpu:samples:samples::"
        customQuery: true
        # Match using service_name label (standard Grafana label set by ACM)
        # Also include equipment for filtering
        query: '{service_name="${__span.serviceName}",equipment="${__span.tags.equipment}"}'
        tags:
          - key: acm.equipment
            value: equipment
          - key: acm.run_id
            value: run_id

  # Loki - Log Aggregation
  - name: Loki
    type: loki
    access: proxy
    url: http://loki:3100
    uid: loki-ds
    isDefault: false
    jsonData:
      maxLines: 1000
      # Derived fields: extract trace_id from label to link to Tempo traces
      derivedFields:
        - datasourceUid: tempo-ds
          matcherType: label
          matcherRegex: trace_id
          name: TraceID
          url: '$${__value.raw}'
          urlDisplayLabel: View Trace

  # Pyroscope - Continuous Profiling
  # Provides CPU and memory profiling with trace correlation
  - name: Pyroscope
    type: grafana-pyroscope-datasource
    access: proxy
    url: http://pyroscope:4040
    uid: pyroscope-ds
    isDefault: false
    jsonData:
      # Enable trace correlation via tracesToLogs-style linking
      tracesToLogsV2:
        datasourceUid: tempo-ds
        spanStartTimeShift: '-5m'
        spanEndTimeShift: '5m'
        filterByTraceID: true

  # Microsoft SQL Server - ACM Business Data
  # Note: Uses host.docker.internal to connect from Docker container to host SQL Server
  # IMPORTANT: SQL login 'grafana_reader' must exist:
  #   sqlcmd -S "localhost\B19CL3PCQLSERVER" -d master -E -Q "
  #     CREATE LOGIN [grafana_reader] WITH PASSWORD = 'ACMGrafana2024!', CHECK_POLICY = OFF;
  #     USE ACM; CREATE USER [grafana_reader] FOR LOGIN [grafana_reader];
  #     ALTER ROLE [db_datareader] ADD MEMBER [grafana_reader];"
  - name: MSSQL
    type: mssql
    access: proxy
    url: host.docker.internal:1433
    uid: mssql-ds
    isDefault: false
    user: grafana_reader
    jsonData:
      authenticationType: SQL Server Authentication
      database: ACM
      encrypt: "disable"
      connMaxLifetime: 14400
      maxIdleConns: 100
      maxOpenConns: 100
    secureJsonData:
      password: "ACMGrafana2024!"
    editable: true
