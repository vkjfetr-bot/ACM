# Grafana Datasources for ACM Observability Stack (Docker)
# ==========================================================
# Auto-provisioned when Grafana starts
# Uses Docker container names for internal networking

apiVersion: 1

datasources:
  # Prometheus - Metrics (DEFAULT)
  - name: Prometheus
    type: prometheus
    access: proxy
    url: http://prometheus:9090
    uid: prometheus-ds
    isDefault: true
    jsonData:
      httpMethod: POST
      exemplarTraceIdDestinations:
        - name: trace_id
          datasourceUid: tempo-ds
          urlDisplayLabel: View Trace

  # Tempo - Distributed Tracing
  - name: Tempo
    type: tempo
    access: proxy
    url: http://tempo:3200
    uid: tempo-ds
    isDefault: false
    jsonData:
      httpMethod: GET
      serviceMap:
        datasourceUid: prometheus-ds
      search:
        hide: false
      nodeGraph:
        enabled: true
      lokiSearch:
        datasourceUid: loki-ds
      tracesToLogsV2:
        datasourceUid: loki-ds
        spanStartTimeShift: '-5m'
        spanEndTimeShift: '5m'
        filterByTraceID: true
        filterBySpanID: false
        customQuery: true
        query: '{app="acm"} | trace_id=`${__trace.traceId}`'
        tags:
          - key: equipment
            value: ''
          - key: run_id
            value: ''
      tracesToMetrics:
        datasourceUid: prometheus-ds
        spanStartTimeShift: '-5m'
        spanEndTimeShift: '5m'
        tags:
          - key: equipment
            value: ''
        queries:
          - name: Stage Duration
            query: 'acm_stage_duration_seconds_sum{equipment="${__span.tags.equipment}"}'
          - name: Memory Usage
            query: 'acm_memory_rss_mb{equipment="${__span.tags.equipment}"}'
      # Trace-to-Profile correlation
      # Links from Tempo traces to Pyroscope profiles using service_name label
      tracesToProfiles:
        datasourceUid: pyroscope-ds
        # CPU profile type (primary)
        profileTypeId: process_cpu:cpu:nanoseconds:cpu:nanoseconds
        customQuery: true
        # Match using service_name label (standard Grafana label set by ACM)
        # Also include equipment for filtering
        query: '{service_name="${__span.serviceName}",equipment="${__span.tags["acm.equipment"]}"}'
        tags:
          - key: service_name
            value: ''
          - key: equipment
            value: ''
          - key: run_id
            value: ''

  # Loki - Log Aggregation
  - name: Loki
    type: loki
    access: proxy
    url: http://loki:3100
    uid: loki-ds
    isDefault: false
    jsonData:
      maxLines: 1000
      # Derived fields: extract trace_id from label to link to Tempo traces
      derivedFields:
        - datasourceUid: tempo-ds
          matcherType: label
          matcherRegex: trace_id
          name: TraceID
          url: '$${__value.raw}'
          urlDisplayLabel: View Trace

  # Pyroscope - Continuous Profiling
  # Provides CPU and memory profiling with trace correlation
  - name: Pyroscope
    type: grafana-pyroscope-datasource
    access: proxy
    url: http://pyroscope:4040
    uid: pyroscope-ds
    isDefault: false
    jsonData:
      # Enable trace correlation via tracesToLogs-style linking
      tracesToLogsV2:
        datasourceUid: tempo-ds
        spanStartTimeShift: '-5m'
        spanEndTimeShift: '5m'
        filterByTraceID: true

  # Microsoft SQL Server - ACM Business Data
  # Note: Uses host.docker.internal to connect from Docker container to host SQL Server
  # IMPORTANT: After starting Docker, run the configure script to set credentials:
  #   .\scripts\configure_grafana_mssql.ps1 -User "grafana_reader" -Password "ACMGrafana2024!"
  # Or create the SQL login first:
  #   sqlcmd -S "localhost\B19CL3PCQLSERVER" -E -i scripts/sql/create_grafana_login.sql
  - name: MSSQL
    type: mssql
    access: proxy
    url: host.docker.internal:1433
    uid: mssql-ds
    isDefault: false
    # Credentials are set via API after container starts (see configure_grafana_mssql.ps1)
    # user: grafana_reader  # Set via API
    jsonData:
      authenticationType: SQL Server Authentication
      database: ACM
      encrypt: "false"
      connMaxLifetime: 14400
      maxIdleConns: 100
      maxOpenConns: 100
    # secureJsonData.password is set via API (not stored in version control)
    secureJsonData: {}
    editable: true
